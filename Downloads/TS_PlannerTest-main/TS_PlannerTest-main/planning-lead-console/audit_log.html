<html lang="en"><head>
    <meta charset="UTF-8">
    <title>Planning Lead Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style type="text/tailwindcss">
        @theme {
            --color-primary: #0B1F3A;
            --color-secondary: #0F766E;
            --color-accent: #D4AF37;
            --color-surface: #FFFFFF;
            --color-background: #F8FAFC;
            --color-error: #DC2626;
            --text-display-lg: 1.75rem;
            --text-display-lg--line-height: 2.25rem;
            --text-display-md: 1.25rem;
            --text-display-md--line-height: 1.75rem;
            --text-display-sm: 1rem;
            --text-display-sm--line-height: 1.5rem;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        .focus-visible:focus-visible {
            outline: 2px solid theme('colors.primary');
            outline-offset: 2px;
        }

        .nav-group-header {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: theme('colors.slate.500');
            margin-bottom: 0.5rem;
            margin-top: 1.5rem;
        }

        .nav-group-header:first-child {
            margin-top: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: theme('radius.md');
            transition: all 0.2s ease;
            text-decoration: none;
            color: theme('colors.slate.700');
            position: relative;
        }

        .nav-item:hover {
            background-color: theme('colors.slate.100');
            color: theme('colors.primary');
        }

        .nav-item.active {
            background-color: theme('colors.primary/10');
            color: theme('colors.primary');
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background-color: theme('colors.primary');
            border-radius: 0 2px 2px 0;
        }

        @media (max-width: 767px) {
            .mobile-sidebar {
                position: fixed;
                top: 4rem;
                left: 0;
                right: 0;
                bottom: 0;
                background: white;
                z-index: 40;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .mobile-sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
    <script src="app.js"></script>
    <script src="app_data.js"></script>
</head>

<body class="bg-background min-h-screen text-slate-800">

    <!-- Skip to main content -->
    <a href="#pageContent" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-white px-4 py-2 rounded-lg z-50">
        Skip to main content
    </a>

    <!-- Top Header -->
    <header class="bg-surface px-6 py-4 flex justify-between items-center border-b border-slate-200 sticky top-0 z-30">
        <div class="flex items-center gap-4">
            <button id="mobileMenuBtn" class="md:hidden p-2 rounded-lg hover:bg-slate-100 focus-visible" aria-label="Open navigation menu" aria-expanded="false">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
            
            <div class="flex items-center gap-3">
                <div class="w-8 h-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 400 400" role="img" aria-hidden="true">
                        <!-- Palette: navy (#0B63A7) and teal (#00A99D) -->
                        <!-- Rounded calendar outline -->
                        <rect x="90" y="90" width="220" height="220" rx="24" ry="24" fill="none" stroke="#0B63A7" stroke-width="18" stroke-linejoin="round"></rect>
                        <!-- Day cells (3x2 grid) -->
                        <g stroke="#0B63A7" stroke-width="12" stroke-linecap="round" stroke-linejoin="round" fill="none">
                            <rect x="122" y="147" width="44" height="44" rx="8" ry="8"></rect>
                            <rect x="178" y="147" width="44" height="44" rx="8" ry="8"></rect>
                            <rect x="234" y="147" width="44" height="44" rx="8" ry="8"></rect>
                            <rect x="122" y="209" width="44" height="44" rx="8" ry="8"></rect>
                            <rect x="178" y="209" width="44" height="44" rx="8" ry="8"></rect>
                            <rect x="234" y="209" width="44" height="44" rx="8" ry="8"></rect>
                        </g>
                        <!-- Asynchronous loop (teal) wrapping the calendar -->
                        <g fill="#00A99D" stroke="#00A99D" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M320 260 C360 260 360 120 260 100" fill="none" stroke="#00A99D" stroke-width="22"></path>
                            <circle cx="300" cy="245" r="8"></circle>
                            <circle cx="280" cy="200" r="8"></circle>
                            <circle cx="270" cy="150" r="8"></circle>
                            <path d="M260 100 L246 116 L274 116 Z"></path>
                        </g>
                    </svg>
                </div>
                <h1 class="text-display-md leading-display-md font-bold text-primary">Planning Lead Console</h1>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Import/Export buttons -->
            <button id="importAppData" class="text-sm px-3 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors focus-visible">
                Import App Data
            </button>
            <button id="exportAppData" class="text-sm px-3 py-2 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors focus-visible">
                Export App Data
            </button>
            <input type="file" id="importFile" accept="application/json" class="hidden">

            <!-- User Profile Button -->
            <button id="userProfileButton" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 transition-colors focus-visible" aria-label="User profile" aria-expanded="false" aria-controls="userProfilePopover">
                <div id="userAvatar" class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-medium">
                </div>
                <div class="hidden sm:block">
                    <div id="userName" class="text-sm font-medium text-slate-700"></div>
                </div>
                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
            </button>
        </div>
    </header>

    <!-- User Profile Popover -->
    <div id="userProfilePopover" class="absolute top-16 right-6 bg-surface border border-slate-200 rounded-xl shadow-lg p-4 w-64 z-50 hidden" role="dialog" aria-labelledby="userProfileTitle">
        <div class="flex items-center gap-3 mb-4 pb-3 border-b border-slate-100">
            <div id="popoverUserAvatar" class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-medium">
            </div>
            <div>
                <div id="popoverUserName" class="font-medium text-slate-900"></div>
                <div id="popoverUserEmail" class="text-xs text-slate-500"></div>
            </div>
        </div>
        <div class="space-y-2">
            <button id="signOutButton" class="w-full flex items-center gap-2 px-3 py-2 text-left text-error hover:bg-red-50 rounded-lg transition-colors focus-visible">
                <i data-lucide="log-out" class="w-4 h-4"></i>
                Sign Out
            </button>
        </div>
    </div>

    <!-- Layout wrapper -->
    <div class="flex">

        <!-- Desktop Sidebar -->
        <aside id="sidebar" class="w-64 bg-surface hidden md:block transition-all duration-300 border-r border-slate-200 sticky top-16 h-[calc(100vh-4rem)] overflow-y-auto">
            <nav class="p-6" role="navigation" aria-label="Main navigation" id="sideNav">
                <div class="nav-group-header">Planning</div>
                <a href="planning_week_overview.html" class="nav-item" data-page="planning_week_overview.html">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    Overview
                </a>
            </nav>
        </aside>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobileSidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
        
        <!-- Mobile Sidebar -->
        <aside id="mobileSidebar" class="mobile-sidebar md:hidden">
            <nav class="p-6" role="navigation" aria-label="Main navigation">
                <div class="nav-group-header">Planning</div>
                <a href="planning_week_overview.html" class="nav-item" data-page="planning_week_overview.html">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    Overview
                </a>
            </nav>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 p-6 overflow-y-auto min-h-[calc(100vh-4rem)]" id="pageContent" role="main"><head_content_code>
<title>Audit Log - Planning Lead Console</title>
</head_content_code>

<html_content_code>
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <nav class="flex items-center gap-2 text-sm text-slate-500 mb-2">
                    <a href="planning_week_overview.html" class="hover:text-primary transition-colors">Overview</a>
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    <span class="text-slate-700 font-medium">Audit Log</span>
                </nav>
                <h1 class="text-[1.75rem] leading-[2.25rem] font-bold text-primary">Audit Log</h1>
                <p class="text-sm text-slate-600 mt-1">Filterable timeline of audit events for compliance and traceability</p>
            </div>
            <button id="exportAuditBtn" class="flex items-center gap-2 px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors focus-visible">
                <i data-lucide="download" class="w-4 h-4"></i>
                Export JSON
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="bg-surface rounded-xl border border-slate-200 p-6 mb-6">
        <h2 class="text-[1.25rem] leading-[1.75rem] font-semibold text-slate-900 mb-4">Filters</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Week Filter -->
            <div>
                <label for="weekFilter" class="block text-sm font-medium text-slate-700 mb-2">Week</label>
                <select id="weekFilter" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    <option value="">All Weeks</option>
                </select>
            </div>
            
            <!-- Entity Type Filter -->
            <div>
                <label for="entityTypeFilter" class="block text-sm font-medium text-slate-700 mb-2">Entity Type</label>
                <select id="entityTypeFilter" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    <option value="">All Types</option>
                    <option value="Activity">Activity</option>
                    <option value="PriorityList">Priority List</option>
                    <option value="Capacity">Capacity</option>
                    <option value="Assignment">Assignment</option>
                    <option value="PlanSnapshot">Plan Snapshot</option>
                    <option value="OverrideRequest">Override Request</option>
                    <option value="ChangeRequest">Change Request</option>
                </select>
            </div>
            
            <!-- Event Type Filter -->
            <div>
                <label for="eventTypeFilter" class="block text-sm font-medium text-slate-700 mb-2">Event Type</label>
                <select id="eventTypeFilter" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    <option value="">All Events</option>
                    <option value="ACTIVITY_CREATED">Activity Created</option>
                    <option value="CLASSIFICATION_OVERRIDE">Classification Override</option>
                    <option value="PRIORITY_CHANGED">Priority Changed</option>
                    <option value="CAPACITY_UPDATED">Capacity Updated</option>
                    <option value="ASSIGNMENT_CREATED">Assignment Created</option>
                    <option value="PLAN_PUBLISHED">Plan Published</option>
                    <option value="APPROVAL_DECISION">Approval Decision</option>
                </select>
            </div>
            
            <!-- Actor Filter -->
            <div>
                <label for="actorFilter" class="block text-sm font-medium text-slate-700 mb-2">Actor</label>
                <select id="actorFilter" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    <option value="">All Users</option>
                </select>
            </div>
        </div>
        
        <div class="flex items-center gap-4 mt-4 pt-4 border-t border-slate-100">
            <button id="clearFiltersBtn" class="text-sm text-slate-600 hover:text-primary transition-colors">
                Clear All Filters
            </button>
            <div class="flex items-center gap-2">
                <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
                <input type="text" id="searchInput" placeholder="Search events, actors, or entity IDs..." class="px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary w-64">
            </div>
        </div>
    </div>

    <!-- Contextual Tips -->
    <div id="contextualTip" class="bg-accent/10 border border-accent/30 rounded-lg p-4 mb-6">
        <div class="flex items-start gap-3">
            <i data-lucide="info" class="w-5 h-5 text-accent mt-0.5 flex-shrink-0"></i>
            <div>
                <p class="text-sm text-slate-700">
                    <strong>Tip:</strong> All critical writes are audited; use filters to focus on specific events or time periods. 
                    Expandable items show detailed before/after changes for transparency.
                </p>
            </div>
        </div>
    </div>

    <!-- Error State Banner -->
    <div id="errorBanner" class="hidden bg-error/10 border border-error/30 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-error"></i>
                <div>
                    <p class="text-sm font-medium text-error">Failed to load audit events</p>
                    <p class="text-sm text-error/80">Unable to fetch audit data. Please try again.</p>
                </div>
            </div>
            <button id="retryBtn" class="px-3 py-1.5 bg-error text-white text-sm rounded hover:bg-error/90 transition-colors">
                Retry
            </button>
        </div>
    </div>

    <!-- Audit Events List -->
    <div class="bg-surface rounded-xl border border-slate-200">
        <div class="p-6 border-b border-slate-200">
            <div class="flex items-center justify-between">
                <h2 class="text-[1.25rem] leading-[1.75rem] font-semibold text-slate-900">Events Timeline</h2>
                <div class="flex items-center gap-4 text-sm text-slate-600">
                    <span id="eventCount">Loading events...</span>
                    <div class="flex items-center gap-2">
                        <label for="sortOrder" class="text-sm">Sort:</label>
                        <select id="sortOrder" class="px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-primary/20">
                            <option value="desc">Newest First</option>
                            <option value="asc">Oldest First</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Events Container -->
        <div id="eventsContainer" class="divide-y divide-slate-100">
            <div class="p-6 text-center text-slate-500">
                <i data-lucide="loader" class="w-6 h-6 mx-auto animate-spin mb-3"></i>
                <p>Loading audit events...</p>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden p-12 text-center">
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="file-text" class="w-8 h-8 text-slate-400"></i>
            </div>
            <h3 class="text-lg font-medium text-slate-900 mb-2">No audit events found</h3>
            <p class="text-slate-600 mb-4">No audit events match the selected filters.</p>
            <button id="clearFiltersFromEmpty" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                Clear Filters
            </button>
        </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="hidden flex items-center justify-between mt-6">
        <div class="text-sm text-slate-600">
            Showing <span id="pageInfo">1-50 of 100</span> events
        </div>
        <div class="flex items-center gap-2">
            <button id="prevPage" class="px-3 py-2 border border-slate-300 rounded text-sm hover:bg-slate-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
            </button>
            <div id="pageNumbers" class="flex items-center gap-1">
                <!-- Dynamic page numbers will be inserted here -->
            </div>
            <button id="nextPage" class="px-3 py-2 border border-slate-300 rounded text-sm hover:bg-slate-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div id="eventDetailModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-surface rounded-xl shadow-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b border-slate-200">
            <h3 class="text-[1.25rem] leading-[1.75rem] font-semibold text-slate-900">Event Details</h3>
            <button id="closeModal" class="p-2 hover:bg-slate-100 rounded-lg transition-colors focus-visible">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="modalContent" class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <!-- Dynamic content will be inserted here -->
        </div>
    </div>
</div>
</html_content_code>

<script_content_code>

</script_content_code></main>

    </div>

    <script id="container-script">
        lucide.createIcons();

        // Namespacing for Import/Export
        const APP_PREFIX = window.APP_PREFIX || 'PLC__';

        // Mobile navigation toggle
        (function mobileToggle(){
            const btn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.getElementById('mobileSidebarOverlay');
            
            if (!btn || !sidebar || !overlay) return;
            
            btn.addEventListener('click', () => {
                const isOpen = sidebar.classList.contains('open');
                
                btn.setAttribute('aria-expanded', String(!isOpen));
                
                if (isOpen) {
                    sidebar.classList.remove('open');
                    overlay.classList.add('hidden');
                    btn.focus();
                } else {
                    sidebar.classList.add('open');
                    overlay.classList.remove('hidden');
                    // Focus first nav item
                    const firstNavItem = sidebar.querySelector('.nav-item');
                    if (firstNavItem) firstNavItem.focus();
                }
            });

            // Close on overlay click
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
                btn.setAttribute('aria-expanded', 'false');
                btn.focus();
            });

            // Close on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    overlay.classList.add('hidden');
                    btn.setAttribute('aria-expanded', 'false');
                    btn.focus();
                }
            });
        }());

        // Navigation active state management
        function updateActiveNavItem() {
            const currentPage = new URLSearchParams(window.location.search).get('page') || 
                               window.location.pathname.split('/').pop() || 
                               'planning_week_overview.html';
            
            // Update both desktop and mobile nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                const itemPage = item.getAttribute('data-page') || item.getAttribute('href');
                if (itemPage === currentPage) {
                    item.classList.add('active');
                    item.setAttribute('aria-current', 'page');
                } else {
                    item.classList.remove('active');
                    item.removeAttribute('aria-current');
                }
            });
        }

        // Update active state on page load and when navigation changes
        updateActiveNavItem();
        window.addEventListener('popstate', updateActiveNavItem);

        // User management via Auth service if available, else dummy
        const UserUtils = {
            getCurrentUser() {
                if (window.Auth?.getCurrentUser) return window.Auth.getCurrentUser();
                let currentUserId = localStorage.getItem(APP_PREFIX + 'currentUserId');
                if (!currentUserId) {
                    localStorage.setItem(APP_PREFIX + 'currentUserId', 'u-alice');
                    currentUserId = 'u-alice';
                }
                const userData = localStorage.getItem(APP_PREFIX + 'users_' + currentUserId);
                try { 
                    if (userData) return JSON.parse(userData);
                    
                    // Fallback to dummy data from localStorage if available
                    const usersData = localStorage.getItem('plc::users');
                    if (usersData) {
                        const users = JSON.parse(usersData);
                        const user = users.find(u => u.id === currentUserId);
                        if (user) return user;
                    }
                    
                    // Final fallback
                    return {
                        id: 'u-alice',
                        firstName: 'Alice',
                        lastName: 'Nguyen',
                        role: 'PLANNING_LEAD',
                        email: 'alice.nguyen@example.local'
                    };
                } catch { 
                    return null; 
                }
            },
            signOut() {
                if (window.Auth?.signOut) return window.Auth.signOut();
                localStorage.removeItem(APP_PREFIX + 'currentUserId');
                window.location.reload();
            },
            getUserDisplayName(user) {
                if (!user) return 'Guest';
                return user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : (user.firstName || user.lastName || 'User');
            },
            getUserInitials(user) {
                if (!user) return '?';
                const first = user.firstName?.charAt(0) || '';
                const last  = user.lastName?.charAt(0)  || '';
                return (first + last).toUpperCase() || 'U';
            }
        };

        window.UserUtils = UserUtils;

        function initializeUserProfile() {
            const currentUser = UserUtils.getCurrentUser();
            const userAvatar = document.getElementById('userAvatar');
            const userName   = document.getElementById('userName');
            const popoverUserAvatar = document.getElementById('popoverUserAvatar');
            const popoverUserName = document.getElementById('popoverUserName');
            const popoverUserEmail = document.getElementById('popoverUserEmail');
            
            const displayName = UserUtils.getUserDisplayName(currentUser);
            const initials = UserUtils.getUserInitials(currentUser);
            
            if (userAvatar) userAvatar.textContent = initials;
            if (userName) userName.textContent = displayName;
            if (popoverUserAvatar) popoverUserAvatar.textContent = initials;
            if (popoverUserName) popoverUserName.textContent = displayName;
            if (popoverUserEmail) popoverUserEmail.textContent = currentUser?.email || '';
        }
        initializeUserProfile();

        // Profile popover management
        (function profilePopover(){
            let popoverVisible = false;
            const btn = document.getElementById('userProfileButton');
            const popover = document.getElementById('userProfilePopover');
            
            if (!btn || !popover) return;
            
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                popoverVisible = !popoverVisible;
                
                if (popoverVisible) {
                    popover.classList.remove('hidden');
                    btn.setAttribute('aria-expanded', 'true');
                    // Focus first interactive element in popover
                    const signOutBtn = document.getElementById('signOutButton');
                    if (signOutBtn) signOutBtn.focus();
                } else {
                    popover.classList.add('hidden');
                    btn.setAttribute('aria-expanded', 'false');
                }
            });
            
            // Close on outside click
            document.addEventListener('click', (e) => {
                if (popoverVisible && !popover.contains(e.target) && !btn.contains(e.target)) {
                    popover.classList.add('hidden');
                    popoverVisible = false;
                    btn.setAttribute('aria-expanded', 'false');
                }
            });

            // Close on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && popoverVisible) {
                    popover.classList.add('hidden');
                    popoverVisible = false;
                    btn.setAttribute('aria-expanded', 'false');
                    btn.focus();
                }
            });
            
            // Sign out handler
            const signOutBtn = document.getElementById('signOutButton');
            if (signOutBtn) {
                signOutBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to sign out?')) {
                        UserUtils.signOut();
                    }
                });
            }
        }());

        // Import/Export functionality (namespaced)
        document.getElementById('exportAppData')?.addEventListener('click', () => {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith(APP_PREFIX) || key.startsWith('plc::'))) {
                    data[key] = localStorage.getItem(key);
                }
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "planning_console_data.json";
            link.click();
            URL.revokeObjectURL(link.href);
        });

        document.getElementById('importAppData')?.addEventListener('click', () => {
            document.getElementById('importFile').click();
        });

        document.getElementById('importFile')?.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    let importedCount = 0;
                    
                    Object.entries(data).forEach(([key, value]) => {
                        if (key.startsWith(APP_PREFIX) || key.startsWith('plc::')) {
                            localStorage.setItem(key, value);
                            importedCount++;
                        }
                    });
                    
                    if (importedCount > 0) {
                        alert(`✅ Successfully imported ${importedCount} data items. Please refresh the page to see changes.`);
                    } else {
                        alert('⚠️ No compatible data found in the file.');
                    }
                } catch (err) {
                    console.error('Import error:', err);
                    alert('❌ Failed to import: Invalid JSON format or corrupted file.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        });

        // Delegated quick actions handler
        document.addEventListener('click', (e) => {
            const el = e.target.closest('[data-action]');
            if (!el) return;
            
            const action = el.getAttribute('data-action');
            if (window.AppActions && typeof window.AppActions[action] === 'function') {
                e.preventDefault();
                try {
                    window.AppActions[action](el);
                } catch (error) {
                    console.error(`Error executing action ${action}:`, error);
                    el.setAttribute('disabled', 'true');
                    el.setAttribute('title', 'Action failed');
                }
            } else {
                el.setAttribute('disabled', 'true');
                el.setAttribute('title', 'Action not available');
                console.warn(`Action ${action} not found in window.AppActions`);
            }
        });

        // Toast notification helper
        window.showToast = function(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-opacity duration-300 ${
                type === 'success' ? 'bg-secondary' : 
                type === 'error' ? 'bg-error' : 
                'bg-slate-600'
            }`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        };
    </script>

    DYNAMIC_JS_LOGIC_SCRIPT



<script id="page-logic" type="module">
import { getAuditEvents, getUsers, getWeekCalendars } from './page-logic.js';

// Page state
let currentFilters = {
    weekId: '',
    entityType: '',
    eventType: '',
    actorId: '',
    search: ''
};
let currentSort = 'desc';
let currentPage = 1;
const pageSize = 50;
let allEvents = [];
let filteredEvents = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    funInitializeFilters();
    funLoadAuditEvents();
    funSetupEventListeners();
});

// Initialize filter dropdowns
function funInitializeFilters() {
    // Get weeks and populate week filter
    const weeks = getWeekCalendars();
    const weekSelect = document.getElementById('weekFilter');
    
    weeks.forEach(week => {
        const option = document.createElement('option');
        option.value = week.id;
        option.textContent = `${week.id} (${new Date(week.startDate).toLocaleDateString('en-GB', {
            month: 'short',
            day: 'numeric'
        })} - ${new Date(week.endDate).toLocaleDateString('en-GB', {
            month: 'short', 
            day: 'numeric'
        })})`;
        weekSelect.appendChild(option);
    });

    // Get users and populate actor filter
    const users = getUsers();
    const actorSelect = document.getElementById('actorFilter');
    
    users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.firstName} ${user.lastName}`;
        actorSelect.appendChild(option);
    });
}

// Load audit events from storage
function funLoadAuditEvents() {
    try {
        // Method: getAuditEvents({ filters: object }) 
        // Returns: Array<AuditEvent> sorted by timestamp desc
        // Collections used: auditEvents
        // Purpose: Fetches all audit events and applies any pre-filtering if provided
        allEvents = getAuditEvents({ filters: {} });
        funApplyFiltersAndSort();
        funUpdateEventCount();
        funHideErrorBanner();
    } catch (error) {
        console.error('Failed to load audit events:', error);
        funShowErrorBanner();
    }
}

// Apply current filters and sorting
function funApplyFiltersAndSort() {
    filteredEvents = allEvents.filter(event => {
        // Week filter
        if (currentFilters.weekId && event.weekId !== currentFilters.weekId) {
            return false;
        }
        
        // Entity type filter
        if (currentFilters.entityType && event.entityType !== currentFilters.entityType) {
            return false;
        }
        
        // Event type filter
        if (currentFilters.eventType && event.type !== currentFilters.eventType) {
            return false;
        }
        
        // Actor filter
        if (currentFilters.actorId && event.whoId !== currentFilters.actorId) {
            return false;
        }
        
        // Search filter
        if (currentFilters.search) {
            const searchLower = currentFilters.search.toLowerCase();
            const searchFields = [
                event.type,
                event.whoName,
                event.entityId,
                event.entityType
            ].join(' ').toLowerCase();
            
            if (!searchFields.includes(searchLower)) {
                return false;
            }
        }
        
        return true;
    });
    
    // Sort events
    filteredEvents.sort((a, b) => {
        const dateA = new Date(a.when);
        const dateB = new Date(b.when);
        return currentSort === 'desc' ? dateB - dateA : dateA - dateB;
    });
    
    currentPage = 1; // Reset to first page when filters change
    funRenderEvents();
    funUpdatePagination();
}

// Render events for current page
function funRenderEvents() {
    const container = document.getElementById('eventsContainer');
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const pageEvents = filteredEvents.slice(startIndex, endIndex);
    
    if (pageEvents.length === 0) {
        funShowEmptyState();
        return;
    }
    
    funHideEmptyState();
    
    container.innerHTML = '';
    
    pageEvents.forEach(event => {
        const eventElement = funCreateEventElement(event);
        container.appendChild(eventElement);
    });
}

// Create individual event element
function funCreateEventElement(event) {
    const eventDiv = document.createElement('div');
    eventDiv.className = 'p-6 hover:bg-slate-50 transition-colors';
    
    const eventDate = new Date(event.when);
    const timeAgo = funGetTimeAgo(eventDate);
    const eventTypeBadge = funGetEventTypeBadge(event.type);
    
    eventDiv.innerHTML = `
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                    ${eventTypeBadge}
                    <span class="text-sm text-slate-500">${timeAgo}</span>
                </div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="font-medium text-slate-900">${event.whoName || 'System'}</span>
                    <span class="text-sm text-slate-500">modified</span>
                    <span class="text-sm font-medium text-primary">${event.entityType}</span>
                    <code class="text-xs bg-slate-100 px-2 py-1 rounded">${event.entityId}</code>
                </div>
                ${event.weekId ? `<div class="text-sm text-slate-600 mb-3">Week: ${event.weekId}</div>` : ''}
                <div class="text-sm text-slate-700">
                    ${funGetEventDescription(event)}
                </div>
                ${event.metadata ? `<div class="text-xs text-slate-500 mt-2">Metadata: ${event.metadata}</div>` : ''}
            </div>
            <div class="flex items-center gap-2 ml-4">
                <button class="expandEventBtn text-sm text-primary hover:text-primary/80 transition-colors focus-visible" 
                        data-event='${JSON.stringify(event)}'>
                    <i data-lucide="eye" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <div class="hidden expandableContent mt-4 pt-4 border-t border-slate-100">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-slate-900 mb-2">Before</h4>
                    <div class="bg-slate-50 rounded p-3 text-sm">
                        <pre class="whitespace-pre-wrap text-xs overflow-x-auto">${event.before || 'N/A'}</pre>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-slate-900 mb-2">After</h4>
                    <div class="bg-slate-50 rounded p-3 text-sm">
                        <pre class="whitespace-pre-wrap text-xs overflow-x-auto">${event.after || 'N/A'}</pre>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-100">
                <div class="flex items-center justify-between">
                    <div class="text-xs text-slate-500">
                        Event ID: ${event.id} • 
                        Timestamp: ${eventDate.toLocaleString('en-GB')}
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="copyBeforeBtn px-2 py-1 text-xs bg-slate-200 hover:bg-slate-300 rounded transition-colors" 
                                data-content='${event.before}' title="Copy Before JSON">
                            Copy Before
                        </button>
                        <button class="copyAfterBtn px-2 py-1 text-xs bg-slate-200 hover:bg-slate-300 rounded transition-colors" 
                                data-content='${event.after}' title="Copy After JSON">
                            Copy After
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add expand/collapse functionality
    const expandBtn = eventDiv.querySelector('.expandEventBtn');
    const expandableContent = eventDiv.querySelector('.expandableContent');
    
    expandBtn.addEventListener('click', () => {
        const isExpanded = !expandableContent.classList.contains('hidden');
        
        if (isExpanded) {
            expandableContent.classList.add('hidden');
            expandBtn.innerHTML = '<i data-lucide="eye" class="w-4 h-4"></i>';
            expandBtn.setAttribute('aria-expanded', 'false');
        } else {
            expandableContent.classList.remove('hidden');
            expandBtn.innerHTML = '<i data-lucide="eye-off" class="w-4 h-4"></i>';
            expandBtn.setAttribute('aria-expanded', 'true');
        }
        
        lucide.createIcons();
    });
    
    // Add copy functionality
    eventDiv.querySelectorAll('.copyBeforeBtn, .copyAfterBtn').forEach(btn => {
        btn.addEventListener('click', () => {
            const content = btn.getAttribute('data-content');
            if (content && content !== 'null') {
                navigator.clipboard.writeText(content).then(() => {
                    window.showToast('Content copied to clipboard', 'success');
                }).catch(() => {
                    window.showToast('Failed to copy content', 'error');
                });
            }
        });
    });
    
    return eventDiv;
}

// Get event type badge
function funGetEventTypeBadge(eventType) {
    const badges = {
        'ACTIVITY_CREATED': '<span class="px-2 py-1 bg-secondary/10 text-secondary text-xs rounded font-medium">Activity Created</span>',
        'CLASSIFICATION_OVERRIDE': '<span class="px-2 py-1 bg-accent/10 text-accent text-xs rounded font-medium">Classification Override</span>',
        'PRIORITY_CHANGED': '<span class="px-2 py-1 bg-primary/10 text-primary text-xs rounded font-medium">Priority Changed</span>',
        'CAPACITY_UPDATED': '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded font-medium">Capacity Updated</span>',
        'ASSIGNMENT_CREATED': '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded font-medium">Assignment Created</span>',
        'PLAN_PUBLISHED': '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded font-medium">Plan Published</span>',
        'APPROVAL_DECISION': '<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded font-medium">Approval Decision</span>'
    };
    
    return badges[eventType] || `<span class="px-2 py-1 bg-slate-100 text-slate-800 text-xs rounded font-medium">${eventType}</span>`;
}

// Get event description
function funGetEventDescription(event) {
    const descriptions = {
        'ACTIVITY_CREATED': 'A new activity was created in the system',
        'CLASSIFICATION_OVERRIDE': 'Activity classification was overridden',
        'PRIORITY_CHANGED': 'Priority order was modified',
        'CAPACITY_UPDATED': 'User capacity was updated',
        'ASSIGNMENT_CREATED': 'New assignment was created',
        'PLAN_PUBLISHED': 'Plan was published to the team',
        'APPROVAL_DECISION': 'Approval decision was made'
    };
    
    return descriptions[event.type] || 'System event occurred';
}

// Get time ago string
function funGetTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-GB');
}

// Update event count display
function funUpdateEventCount() {
    const countElement = document.getElementById('eventCount');
    const total = filteredEvents.length;
    
    if (total === 0) {
        countElement.textContent = 'No events found';
    } else if (total === 1) {
        countElement.textContent = '1 event';
    } else {
        countElement.textContent = `${total} events`;
    }
}

// Update pagination
function funUpdatePagination() {
    const pagination = document.getElementById('pagination');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    const totalEvents = filteredEvents.length;
    const totalPages = Math.ceil(totalEvents / pageSize);
    
    if (totalPages <= 1) {
        pagination.classList.add('hidden');
        return;
    }
    
    pagination.classList.remove('hidden');
    
    const startIndex = (currentPage - 1) * pageSize + 1;
    const endIndex = Math.min(currentPage * pageSize, totalEvents);
    
    pageInfo.textContent = `${startIndex}-${endIndex} of ${totalEvents}`;
    
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
    
    // Update page numbers
    const pageNumbers = document.getElementById('pageNumbers');
    pageNumbers.innerHTML = '';
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `w-8 h-8 text-sm rounded hover:bg-slate-100 transition-colors ${
            i === currentPage ? 'bg-primary text-white hover:bg-primary/90' : 'text-slate-700'
        }`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
            currentPage = i;
            funRenderEvents();
            funUpdatePagination();
        });
        pageNumbers.appendChild(pageBtn);
    }
}

// Show/hide empty state
function funShowEmptyState() {
    document.getElementById('eventsContainer').innerHTML = '';
    document.getElementById('emptyState').classList.remove('hidden');
    document.getElementById('pagination').classList.add('hidden');
}

function funHideEmptyState() {
    document.getElementById('emptyState').classList.add('hidden');
}

// Show/hide error banner
function funShowErrorBanner() {
    document.getElementById('errorBanner').classList.remove('hidden');
    document.getElementById('eventsContainer').innerHTML = `
        <div class="p-6 text-center text-slate-500">
            <i data-lucide="alert-triangle" class="w-6 h-6 mx-auto mb-3 text-error"></i>
            <p>Failed to load audit events</p>
        </div>
    `;
}

function funHideErrorBanner() {
    document.getElementById('errorBanner').classList.add('hidden');
}

// Setup event listeners
function funSetupEventListeners() {
    // Filter change handlers
    document.getElementById('weekFilter').addEventListener('change', (e) => {
        currentFilters.weekId = e.target.value;
        funApplyFiltersAndSort();
        funUpdateEventCount();
    });
    
    document.getElementById('entityTypeFilter').addEventListener('change', (e) => {
        currentFilters.entityType = e.target.value;
        funApplyFiltersAndSort();
        funUpdateEventCount();
    });
    
    document.getElementById('eventTypeFilter').addEventListener('change', (e) => {
        currentFilters.eventType = e.target.value;
        funApplyFiltersAndSort();
        funUpdateEventCount();
    });
    
    document.getElementById('actorFilter').addEventListener('change', (e) => {
        currentFilters.actorId = e.target.value;
        funApplyFiltersAndSort();
        funUpdateEventCount();
    });
    
    // Search input with debounce
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentFilters.search = e.target.value;
            funApplyFiltersAndSort();
            funUpdateEventCount();
        }, 300);
    });
    
    // Sort order change
    document.getElementById('sortOrder').addEventListener('change', (e) => {
        currentSort = e.target.value;
        funApplyFiltersAndSort();
    });
    
    // Clear filters buttons
    document.getElementById('clearFiltersBtn').addEventListener('click', funClearAllFilters);
    document.getElementById('clearFiltersFromEmpty').addEventListener('click', funClearAllFilters);
    
    // Pagination
    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            funRenderEvents();
            funUpdatePagination();
        }
    });
    
    document.getElementById('nextPage').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredEvents.length / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            funRenderEvents();
            funUpdatePagination();
        }
    });
    
    // Export button
    document.getElementById('exportAuditBtn').addEventListener('click', funExportAuditData);
    
    // Retry button
    document.getElementById('retryBtn').addEventListener('click', funLoadAuditEvents);
    
    // Modal handlers
    document.getElementById('closeModal').addEventListener('click', funCloseModal);
    document.getElementById('eventDetailModal').addEventListener('click', (e) => {
        if (e.target.id === 'eventDetailModal') {
            funCloseModal();
        }
    });
    
    // Keyboard handlers
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            funCloseModal();
        }
    });
}

// Clear all filters
function funClearAllFilters() {
    currentFilters = {
        weekId: '',
        entityType: '',
        eventType: '',
        actorId: '',
        search: ''
    };
    
    document.getElementById('weekFilter').value = '';
    document.getElementById('entityTypeFilter').value = '';
    document.getElementById('eventTypeFilter').value = '';
    document.getElementById('actorFilter').value = '';
    document.getElementById('searchInput').value = '';
    
    funApplyFiltersAndSort();
    funUpdateEventCount();
}

// Export audit data
function funExportAuditData() {
    try {
        const exportData = {
            metadata: {
                exportDate: new Date().toISOString(),
                totalEvents: filteredEvents.length,
                filters: currentFilters,
                sort: currentSort
            },
            events: filteredEvents
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
            type: 'application/json' 
        });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `audit_log_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(link.href);
        window.showToast('Audit data exported successfully', 'success');
    } catch (error) {
        console.error('Export failed:', error);
        window.showToast('Failed to export audit data', 'error');
    }
}

// Close modal
function funCloseModal() {
    document.getElementById('eventDetailModal').classList.add('hidden');
}

// Initialize icons after DOM changes
const observer = new MutationObserver(() => {
    lucide.createIcons();
});

observer.observe(document.getElementById('eventsContainer'), {
    childList: true,
    subtree: true
});

</script></body></html>